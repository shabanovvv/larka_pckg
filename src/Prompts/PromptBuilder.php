<?php

namespace Salavey\AiCodeReviewer\Prompts;

/**
 * Собирает промпты (system/user) для запроса к AI-ревьюеру.
 */
class PromptBuilder
{
    /**
     * Создаёт экземпляр билдера промптов.
     */
    public function __construct()
    {}

    /**
     * Создает промпт для анализа кода на русском
     */
    public function buildForReview(string $code, string $language = 'php'): array
    {
        $systemPrompt = $this->buildSystemPrompt($language);
        $userPrompt = $this->buildUserPrompt($code, $language);

        return [
            'system' => $systemPrompt,
            'user' => $userPrompt,
        ];
    }

    /**
     * Системный промпт на русском
     */
    private function buildSystemPrompt(string $language): string
    {
        return <<<PROMPT
            Ты эксперт по ревью кода со специализацией на {$language}.
            
            Проанализируй код по следующим категориям:
            
            1. КАЧЕСТВО КОДА
               - Читаемость и понятность
               - Сложность (цикломатическая, когнитивная)
               - Дублирование кода (принцип DRY)
               - Именование переменных, функций, классов
               - Длина функций/методов
            
            2. БЕЗОПАСНОСТЬ
               - SQL-инъекции
               - XSS (межсайтовый скриптинг)
               - CSRF (межсайтовая подделка запроса)
               - Валидация и фильтрация входных данных
               - Проблемы аутентификации/авторизации
               - Утечка чувствительных данных
            
            3. ПРОИЗВОДИТЕЛЬНОСТЬ
               - Эффективность алгоритмов
               - Оптимизация запросов к базе данных
               - Использование памяти
               - Оптимизация циклов
               - Возможности кэширования
            
            4. ЛУЧШИЕ ПРАКТИКИ
               - Соответствие стандартам кодирования
               - Применение паттернов проектирования
               - Обработка ошибок и исключений
               - Тестируемость кода
               - Поддерживаемость
               
            ВАЖНО: Верни ответ ИСКЛЮЧИТЕЛЬНО как валидный JSON-объект.
            НЕ используй markdown, НЕ оборачивай ответ в ```json или любые другие backticks.
            НЕ добавляй никакого текста до или после JSON.
            
            Структура JSON должна быть строго такой:
            {
                "score": 0-100,
                "summary": "Краткая общая оценка",
                "issues": [
                    {
                        "type": "quality|security|performance|best_practice",
                        "severity": "critical|high|medium|low",
                        "message": "Четкое описание проблемы",
                        "suggestion": "Как исправить"
                    }
                ],
                "suggestions": [
                    "Общие рекомендации по улучшению"
                ]
            }
            
            Будь конкретным, конструктивным и профессиональным. Отвечай на русском языке.
            PROMPT;
    }

    /**
     * Пользовательский промпт на русском
     */
    private function buildUserPrompt(string $code, string $language): string
    {
        return <<<PROMPT
            Пожалуйста, проанализируй этот код на {$language}:

            ```{$language}
            {$code}```
            Предоставь анализ ТОЛЬКО как валидный JSON без дополнительного текста. Отвечай на русском языке.
            PROMPT;
    }
}